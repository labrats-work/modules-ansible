
- name: Check if Kubernetes is installed
  command: kubectl version
  register: kubectl_result
  ignore_errors: true

- name: Install if kubectl version rc is zero
  when: kubectl_result.rc == 1
  block:
    - name: Default kubeadm init (is a multi document yaml).
      ansible.builtin.shell: kubeadm config print init-defaults
      register: kubeadm_config_print

    - name: Split into separate documents (initconfiguration, clusterconfiguration).
      ansible.builtin.debug: 
        msg: "{{ item }}"
      register: kubeadm_config_{{ idx }}
      loop: "{{ kubeadm_config_print.stdout|split('---') }}"
      loop_control:
        index_var: idx

    - name: Combine with user defined vars.
      ansible.builtin.copy:
        content: |-
          {{ dict|combine(changes, recursive=true)|to_nice_yaml }}
        dest: /root/kubeadm_init.yaml
        owner: root
        group: root
        mode: '0600'
      vars:
        dict: "{{ kubeadm_config[0]|from_yaml }}"
        changes: "{{ kubeadm_init }}"

    - name: Restart container runtime
      ansible.builtin.service:
        name: containerd
        state: restarted 

    - name: Run kubectl init
      ansible.builtin.command: kubeadm init --config=/root/kubeadm_init.yaml --upload-certs

    - name: Wait until the file /etc/kubernetes/admin.conf is present before continuing
      ansible.builtin.wait_for:
        path: /etc/kubernetes/admin.conf

    - name: Wait for port 6443 to become open on the host, don't start checking for 10 seconds
      ansible.builtin.wait_for:
        port: 6443
        delay: 10
        host: localhost

    - name: Create .kube directory
      ansible.builtin.file:
        path: .kube
        state: directory
        owner: sysadmin
        group: sysadmin
        mode: '0700'

    - name: Copy admin.conf
      ansible.builtin.copy:
        remote_src: yes
        src: /etc/kubernetes/admin.conf
        dest: .kube/config
        owner: sysadmin
        group: sysadmin
        mode: '0600'

    - name: Copy files for calico init.
      become: no
      ansible.builtin.template:
        src: "templates/calico_init.yaml.j2"
        dest: calico_init.yaml
        owner: sysadmin
        group: sysadmin
        mode: '0600'

    - name: Create tigera operator.
      become: no
      ansible.builtin.command: kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.24.0/manifests/tigera-operator.yaml

    - name: Run calico init.
      become: no
      ansible.builtin.command: kubectl apply -f calico_init.yaml

- name: Get cluster_ca_data from master config file.
  ansible.builtin.shell: grep certificate-authority-data /etc/kubernetes/admin.conf | tr -d ' ' | cut -d ':' -f 2-
  register: grep_cluster_ca_data

- name: Get cluster_server from master config file.
  ansible.builtin.shell: grep server /etc/kubernetes/admin.conf | tr -d ' ' | cut -d ':' -f 2-
  register: grep_cluster_server

- name: Get kubeadm_token.
  ansible.builtin.shell: kubeadm token create
  register: kubeadm_token

- name: Set facts for join data.
  ansible.builtin.set_fact: 
    discovery:
      ca_data: "{{ grep_cluster_ca_data.stdout }}"
      server: "{{ grep_cluster_server.stdout }}"
      tlsBootstrapToken: "{{ kubeadm_token.stdout }}"